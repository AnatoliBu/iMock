# Маппинги Wiremock для API Iiko

## Содержание
1. [Введение](#введение)
2. [Общая структура маппингов](#общая-структура-маппингов)
3. [Типы маппингов](#типы-маппингов)
   - [Аутентификация](#1-аутентификация)
   - [Меню и номенклатура](#2-меню-и-номенклатура)
   - [Стоп-листы](#3-стоп-листы)
   - [Доставка и курьеры](#4-доставка-и-курьеры)
   - [Проверка терминалов](#5-проверка-терминалов)
   - [Организации](#6-организации)
   - [Заказы](#7-заказы)
4. [Редактирование маппингов](#как-редактировать-маппинги)
5. [Примеры полных маппингов](#примеры-полных-маппингов)
6. [Работа с прокси-маппингами](#работа-с-прокси-маппингами)

## Введение
Данный документ описывает маппинги WireMock, которые используются для имитации ответов от API Iiko. Все маппинги расположены на сервере `rdsh2.lphub.net:8080` и доступны с использованием токена авторизации `Bearer test`. 

WireMock Viewer, доступный в директории `tools/wiremock_viewer`, предоставляет удобный интерфейс для просмотра, редактирования и создания маппингов.

## Общая структура маппингов

Маппинги для Iiko API имеют следующую обобщенную структуру:

```json
{
  "id": "уникальный-uuid",
  "name": "Название маппинга",
  "request": {
    "method": "POST",
    "url": "/api/1/...",
    "headers": {
      "Authorization": {
        "equalTo": "Bearer test"
      }
    }
  },
  "response": {
    "status": 200,
    "headers": {
      "Content-Type": "application/json"
    },
    "jsonBody": {
      // Содержимое ответа
    }
  }
}
```

## Типы маппингов

### 1. Аутентификация
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| 11e32f73-f938-41f2-b9ca-e03ed38fe106 | mappings/api/1/access_token | /api/1/access_token | POST | Получение токена авторизации |

**Пример ответа:**
```json
{
  "token": "sample-token-for-testing",
  "validTill": "2099-12-31T23:59:59.999"
}
```

### 2. Меню и номенклатура
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| 549b5a2e-31e5-4445-988a-61d2fa32199f | mappings/__admin/mappings | /__admin/mappings | GET | Получение всех маппингов и данных о меню |
| eaa00480-74c0-40b7-934b-70e558acdc96 | - | /api/1/nomenclature | POST | Получение номенклатуры для конкретной организации |

**Структура номенклатуры:**
```json
{
  "groups": [
    {
      "id": "uuid-группы",
      "name": "Имя группы",
      "order": 0,
      "parentGroup": null,
      "imageLinks": ["url-изображения"],
      "isIncludedInMenu": true
    }
  ],
  "productCategories": [
    {
      "id": "uuid-категории",
      "name": "Имя категории"
    }
  ],
  "products": [
    {
      "id": "uuid-продукта",
      "name": "Название продукта",
      "description": "Описание",
      "additionalInfo": "Дополнительная информация",
      "groupId": "uuid-группы",
      "productCategoryId": "uuid-категории",
      "price": 100.00,
      "order": 0,
      "imageLinks": ["url-изображения"],
      "isDeleted": false
    }
  ],
  "sizes": [
    {
      "id": "uuid-размера",
      "name": "Название размера"
    }
  ],
  "productSizes": [
    {
      "productId": "uuid-продукта",
      "sizeName": "30 см трад.тесто",
      "sizeId": "uuid-размера",
      "priceModificationAmount": 0.0
    }
  ]
}
```

### 3. Стоп-листы
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| 8152bfd7-fe02-403d-a4b3-005cbce56c3b | STOP LIST | /api/1/stop_lists | POST | Получение стоп-листа организации |

**Структура стоп-листа:**
```json
{
  "terminalGroupStopLists": [
    {
      "organizationId": "uuid-организации",
      "terminalGroupId": "uuid-терминальной-группы",
      "items": [
        {
          "balance": 0,
          "productId": "uuid-продукта",
          "sku": "артикул",
          "dateAdd": "2023-02-28 21:31:27.334"
        }
      ]
    }
  ]
}
```

### 4. Доставка и курьеры
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| f33f7e90-3e94-47f4-966b-e5fe8c2d13d3 | mappings/api/1/employees/couriers/locations/by_time_offset | /mappings/api/1/employees/couriers/locations/by_time_offset | POST | Информация о местоположении курьеров |
| 07faca4a-a5e0-4b64-b2ed-6a642c62cbe7 | api_1_deliveries_by_id | /api/1/deliveries/by_id | POST | Получение информации о доставке по ID |

**Структура данных о доставке:**
```json
{
  "deliveries": [
    {
      "id": "uuid-доставки",
      "orderId": "uuid-заказа",
      "completeBefore": "2023-03-01T15:00:00.000",
      "status": "Новая",
      "customerName": "Иван Иванов",
      "customerPhone": "+7(999)123-45-67",
      "address": {
        "city": "Москва",
        "street": "Ленина",
        "home": "10",
        "apartment": "101"
      },
      "orderItems": [
        {
          "productId": "uuid-продукта",
          "name": "Название продукта",
          "amount": 1,
          "price": 100.00
        }
      ]
    }
  ]
}
```

### 5. Проверка терминалов
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| c5f1b3ee-1b74-4a48-be11-8eef89c163db | Jordan is_alive | /api/1/terminal_groups/is_alive | POST | Проверка статуса терминальных групп |

**Структура ответа:**
```json
{
  "isAliveStatus": [
    {
      "isAlive": true,
      "terminalGroupId": "uuid-терминальной-группы",
      "organizationId": "uuid-организации"
    }
  ]
}
```

### 6. Организации
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| 4bf6e6aa-7f12-4c33-8a5d-9eebc889d863 | Organizations | /api/1/organizations | POST | Получение списка организаций |

**Структура ответа:**
```json
{
  "organizations": [
    {
      "id": "uuid-организации",
      "name": "Название организации",
      "country": "Россия",
      "restaurantAddress": "Адрес ресторана",
      "timezone": "Europe/Moscow"
    }
  ]
}
```

### 7. Заказы
| ID | Название | URL | Метод | Описание |
|----|----------|-----|-------|----------|
| d8f1b3ee-1b74-4a48-be11-8eef89c163cc | Orders by id | /api/1/order/by_id | POST | Получение заказа по ID |

**Структура ответа:**
```json
{
  "orders": [
    {
      "id": "uuid-заказа",
      "organizationId": "uuid-организации",
      "timestamp": "2023-02-28T21:31:27.334",
      "creationStatus": "Success",
      "posId": "uuid-терминала",
      "externalNumber": "12345",
      "order": {
        "id": "uuid-заказа",
        "number": "12345",
        "completeBefore": "2023-03-01T15:00:00.000",
        "items": [
          {
            "productId": "uuid-продукта",
            "name": "Название продукта",
            "amount": 1,
            "price": 100.00
          }
        ],
        "total": 100.00
      }
    }
  ]
}
```

## Как редактировать маппинги

### Общие рекомендации
1. Для редактирования маппингов рекомендуется использовать WireMock Viewer, доступный в директории `tools/wiremock_viewer`
2. Альтернативно можно использовать API wiremock: `http://rdsh2.lphub.net:8080/__admin/mappings/{uuid}`
3. Для авторизации используйте заголовок `Authorization: Bearer test`

### Специфика редактирования по типам

#### 1. Меню и номенклатура
- При редактировании данных меню необходимо сохранять структуру JSON
- Для добавления новых продуктов следует добавлять новые элементы в массивы `products`
- ID продуктов должны быть уникальными в формате UUID
- При добавлении продукта не забудьте связать его с группой через `groupId`
- Для модификаторов используйте отдельные продукты с флагом `isModifier: true`

#### 2. Стоп-листы
- Для добавления товара в стоп-лист добавьте новый элемент в массив `items`
- Поле `balance` указывает на доступное количество (0 или отрицательное значение означает, что товара нет в наличии)
- При добавлении товара в стоп-лист убедитесь, что указан правильный `productId`

#### 3. Доставка и курьеры
- При редактировании данных о доставке важно сохранять поля `id`, `posId` и `organizationId`
- Для создания новой доставки создайте новый маппинг с уникальным `id`
- Статусы доставки могут принимать значения: "Новая", "В пути", "Доставлена", "Отменена"

#### 4. Проверка терминалов
- Статус терминала определяется полем `isAlive` (true/false)
- При добавлении новой терминальной группы необходимо также добавить ее в маппинг проверки статуса
- Убедитесь в соответствии `organizationId` и `terminalGroupId`

#### 5. Организации
- Для добавления новой организации добавьте элемент в массив `organizations`
- Обязательно укажите уникальный `id` и заполните обязательные поля `name` и `country`

#### 6. Заказы
- При создании заказа обязательно укажите связанные `id` организации и терминальной группы
- Заполните все необходимые поля для корректного отображения в клиентских приложениях

## Примеры полных маппингов

### Пример 1: Получение токена авторизации
```json
{
  "id": "11e32f73-f938-41f2-b9ca-e03ed38fe106",
  "name": "Получение токена авторизации",
  "request": {
    "method": "POST",
    "url": "/api/1/access_token"
  },
  "response": {
    "status": 200,
    "headers": {
      "Content-Type": "application/json"
    },
    "jsonBody": {
      "token": "sample-token-for-testing",
      "validTill": "2099-12-31T23:59:59.999"
    }
  }
}
```

### Пример 2: Получение списка организаций
```json
{
  "id": "4bf6e6aa-7f12-4c33-8a5d-9eebc889d863",
  "name": "Получение списка организаций",
  "request": {
    "method": "POST",
    "url": "/api/1/organizations",
    "headers": {
      "Authorization": {
        "equalTo": "Bearer test"
      }
    }
  },
  "response": {
    "status": 200,
    "headers": {
      "Content-Type": "application/json"
    },
    "jsonBody": {
      "organizations": [
        {
          "id": "b8f50ab8-779d-448f-9cdc-105e65527660",
          "name": "Тестовая организация",
          "country": "Россия",
          "restaurantAddress": "г. Москва, ул. Ленина, д. 1",
          "timezone": "Europe/Moscow"
        }
      ]
    }
  }
}
```

### Пример 3: Стоп-лист
```json
{
  "id": "8152bfd7-fe02-403d-a4b3-005cbce56c3b",
  "name": "Получение стоп-листа",
  "request": {
    "method": "POST",
    "url": "/api/1/stop_lists",
    "headers": {
      "Authorization": {
        "equalTo": "Bearer test"
      }
    }
  },
  "response": {
    "status": 200,
    "headers": {
      "Content-Type": "application/json"
    },
    "jsonBody": {
      "terminalGroupStopLists": [
        {
          "organizationId": "b8f50ab8-779d-448f-9cdc-105e65527660",
          "terminalGroupId": "66c445d4-d431-4f2f-9e9e-4d75a8475942",
          "items": [
            {
              "balance": 0,
              "productId": "755042de-4aba-4913-8f9f-f546bcd8c646",
              "sku": "SKU001",
              "dateAdd": "2023-02-28 21:31:27.334"
            }
          ]
        }
      ]
    }
  }
}
```

## Работа с прокси-маппингами

WireMock позволяет создавать прокси-маппинги, которые перенаправляют запросы на реальные API Iiko при необходимости. Это полезно в случаях когда:

1. Вы разрабатываете интеграцию с новым API, для которого еще нет готовых моков
2. Хотите записать реальные ответы для дальнейшего создания моков
3. Часть функциональности требует реальных данных, а часть может быть эмулирована

### Пример прокси-маппинга:

```json
{
  "id": "6a31c8e4-b60c-4f7b-9c31-d9a8c0f6b7b9",
  "name": "Прокси для нового API",
  "request": {
    "urlPattern": "/api/1/new_endpoint/.*",
    "method": "ANY"
  },
  "response": {
    "proxyBaseUrl": "https://api-eu.syrve.live",
    "additionalProxyRequestHeaders": {
      "Authorization": "Bearer {{request.headers.Authorization}}"
    }
  }
}
```

### Создание прокси-маппингов через WireMock Viewer:

1. Нажмите на кнопку "Создать маппинг"
2. Выберите тип маппинга "Прокси"
3. Заполните условия запроса (URL, метод, заголовки)
4. Во вкладке "Прокси" укажите базовый URL реального API (например, `https://api-eu.syrve.live`)
5. При необходимости добавьте дополнительные заголовки для прокси-запроса
6. Сохраните маппинг

### Запись реальных взаимодействий:

Для записи всех взаимодействий с API Iiko можно запустить WireMock с параметром:

```bash
java -jar wiremock.jar --record-mappings --proxy-all="https://api-eu.syrve.live" --verbose
```

После этого все запросы к WireMock будут перенаправлены на реальный API, а ответы будут записаны в директорию `mappings/` для дальнейшего использования. 